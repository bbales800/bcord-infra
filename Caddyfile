{
    email admin@b-cord.run.place
    acme_ca https://acme.zerossl.com/v2/DV90
}

# ==========================================================
# Main BCord site and backend routing
# ==========================================================
b-cord.run.place, www.b-cord.run.place {
    encode zstd gzip

    # ------------------------------------------------------
    # 1️⃣ Route API + WebSocket traffic to backend container
    # ------------------------------------------------------
    handle /api/* {
        reverse_proxy bcord:9000 {
            transport http {
                versions 1.1
            }
            header_up Host {http.request.host}
            header_up -Accept-Encoding
            header_up -Alt-Svc
            header_up -Te
            header_up -Transfer-Encoding
        }
    }

    handle /ws* {
        reverse_proxy bcord:9000 {
            transport http {
                versions 1.1
            }
            header_up Host {http.request.host}
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
            header_up -Accept-Encoding
            header_up -Alt-Svc
            header_up -Te
            header_up -Transfer-Encoding
        }
    }

    # ------------------------------------------------------
    # 2️⃣ Serve static React frontend build for all else
    # ------------------------------------------------------
    handle {
        root * /srv/bcord/site
        try_files {path} /index.html
        file_server
    }

    # ------------------------------------------------------
    # 3️⃣ Log access for debugging / observability
    # ------------------------------------------------------
    log {
        output file /data/access.log {
            roll_size 10MiB
            roll_keep 5
        }
    }
}

# ------------------------------------------------------
# Monitoring dashboards
# ------------------------------------------------------
grafana.b-cord.run.place {
    reverse_proxy bcord-grafana:3000
}

prometheus.b-cord.run.place {
    reverse_proxy bcord-prometheus:9090
}

