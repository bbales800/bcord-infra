{
    email admin@b-cord.run.place
    acme_ca https://acme.zerossl.com/v2/DV90
}

# -----------------------------------------------------------------------------
# HTTP listener for ACME challenges + HTTPâ†’HTTPS redirects
# -----------------------------------------------------------------------------
http://b-cord.run.place, http://www.b-cord.run.place {
    handle_path /.well-known/acme-challenge/* {
        root * /var/lib/caddy/.local/share/caddy/acme
        file_server
    }

    redir https://{host}{uri} permanent
}

https://b-cord.run.place, https://www.b-cord.run.place {
    encode zstd gzip

    # -------------------------------------------------------------------------
    # Global security + CORS headers (CSRF-aware)
    # -------------------------------------------------------------------------
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Resource-Policy "same-site"
        Cross-Origin-Embedder-Policy "require-corp"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://b-cord.run.place https://b-cord.run.place"
        Access-Control-Allow-Origin https://{host}
        Access-Control-Allow-Credentials true
        Access-Control-Allow-Headers "Authorization, Content-Type"
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        Vary "Origin"
    }

    @cors_preflight {
        method OPTIONS
    }
    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin https://{host}
            Access-Control-Allow-Credentials true
            Access-Control-Allow-Headers "Authorization, Content-Type"
            Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
            Vary "Origin"
        }
        respond "" 204
    }

    @api path /api/*
    reverse_proxy @api bcord-backend:9000

    # -------------------------------------------------------------------------
    # Prometheus scrape endpoint exposed via HTTPS
    # -------------------------------------------------------------------------
    handle_path /metrics {
        header {
            Content-Type "text/plain; version=0.0.4"
            Cache-Control "no-store"
        }
        reverse_proxy bcord-backend:9000
    }

    # -------------------------------------------------------------------------
    # CAPTCHA proxy (binary-safe)
    # -------------------------------------------------------------------------
    handle_path /captcha* {
        reverse_proxy bcord-backend:9000
    }

    # -------------------------------------------------------------------------
    # WebSocket upgrades
    # -------------------------------------------------------------------------
    @ws path /ws*
    reverse_proxy @ws bcord-backend:9000

    # -------------------------------------------------------------------------
    # Static frontend (React build output)
    # -------------------------------------------------------------------------
    handle_path / {
        root * /srv/bcord/site
        try_files {path} /index.html
        file_server
    }

    # -------------------------------------------------------------------------
    # Access logging for observability
    # -------------------------------------------------------------------------
    log {
        output file /data/access.log {
            roll_size 10MiB
            roll_keep 5
        }
    }
}

# -----------------------------------------------------------------------------
# Monitoring dashboards (HTTPS explicitly defined)
# -----------------------------------------------------------------------------
grafana.b-cord.run.place {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
    }
    reverse_proxy bcord-grafana:3000
}

prometheus.b-cord.run.place {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "same-origin"
    }
    reverse_proxy bcord-prometheus:9090
}
